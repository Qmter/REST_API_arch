# Новая струкруа генераторов тестов

```json
{
    "<Имя_тестироемого_endpoint>": {
        "PRESET": {
            "1": {
                "description": "Описание теста",
                "steps": {
                    "1": {
                        "endpoint": "<Имя_endpoint>",
                        "method": "<Метод>",
                        "parameters": {"<Параметры>"},
                        "expected": {
                            "errCode": "<Код_ошибки>",
                            "HTTPCode": "<Код_HTTP>"
                        }
                    }
                }
            },
        },
        "TESTS": {},
        "AFTER-TEST": {}
    }
}
```

## Пояснение к формату:

- `<Имя_тестироемого_endpoint>` - Имя endpoint, который будет тестироваться
- `"PRESET"` -  Блок теста для создания тестовой среды
- `"TESTS"` - Блок теста для тестирования
- `"AFTER-TEST"` - Блок теста для очистки тестовой среды
- `"description"` - Описание теста
- `"steps"` - Шаги теста
- `"endpoint"` - endpoint, к которому пойдет запрос
- `"method"` - Метод запроса (`GET`, `POST`)
- `"parameters"` - Параметры запроса
- `"expected"` - Ожидаемый результат запроса
- `"errCode"` - Код ошибки
- `"HTTPCode"` - Код HTTP ответа
___

## Значения которые можно указывать в parameters:

|Значение|Что делает|
|-|-|
|`"random"`|Берет рандомное значение по паттерну или из диапазона минимального и макимального значения из схемы `openapi`|
|`"minimum"`|Берет минимальное значение из схемы `openapi`|
|`"maximum"`|Берет максимальное значение из схемы `openapi`|
|`Константа`|Можно указать конкретное значение для параметра|
|`Ссылка на значение другой части теста`|Берет из указаной части теста необходимое значение|
___

## Пример простого теста:
```json
{
  "/interfaces/tunnel/multicast": { // endpoint к которому будет сгенерирован тест
    "TESTS": { // Блок теста для тестирования
      "1": { // Первый тест
        "description": "Set on multicast", // описание теста
        "steps": { // Шаги теста
          "1": { // Первый шаг теста
            "endpoint": "/interfaces/tunnel/add", // endpoint к которому пойдет запрос
            "method": "POST", // метод запроса
            "parameters": { // параметры запроса
              "ifname": "random", // имя интерфейса
              "source": "random", // адрес источника
              "tos": "maximum", // тип трафика
              "key": "maximum"  // ключ
            },
            "expected": { // ожидаемый результат запроса
              "errCode": 0, // код ошибки
              "httpCode": 200 // код HTTP ответа
            }
          },
        }
      }
    },
    "PRESET": {}, // Блок теста для создания тестовой среды
    "AFTER-TEST": {} // Блок теста для очистки тестовой среды
  }
}
```
___


# Есть возможность создавать шаблоны тестов, которые можно использовать в других тестах


Шаблоны хранятся в папке `/templates`

Для их использования необходимо в качестве значения шага теста указать `"template": "#TEMPLATES.<endpoint>".<Доп.вложенност>`

## Пояснение к формату:

- `#TEMPLATES.` - Символ, который указывает на использование шаблона
- `<endpoint>` - Имя endpoint, шаблонного ендпоинта
- `<Доп.вложенност>` - Если нам нужен не весь шаблон, а его часть, то мы указываем через точку, что именно нам нужно


## Пример шаблона:
```json
{
    "/vrf": { // Шаблонный ендпоинт
        "TESTS": { // Блок теста
            "ADD": {
                "endpoint": "/vrf",
                "method": "POST",
                "parameters": {
                    "action": "add",
                    "vrf_name": "random"
                },
                "expected": {"errCode": 0, "httpCode": 200}
            },
            "DELETE": {
                "endpoint": "/vrf",
                "method": "POST",
                "parameters": {
                    "action": "delete",
                    "vrf_name": "random"
                },
                "expected": {"errCode": 0, "httpCode": 200}
            }
        }
    }
}
```
## Пояснение к шаблону:
##### У нас есть endpoint `/vrf`, который мы часто используем. У него есть два константных сотояния: `add` и `delete`. В тестах мы часто используем эти состояния, поэтому мы создали шаблон для них. В шаблоне мы тесты разделили на ADD и DELETE для простого обращения к ним.

### ВАЖНЫЙ МОМЕНТ: имя шаблона долно иметь такой формат: `<_имя_ендпоинта.json>`, например: `_vrf_templates.json`

## Пример использования шаблона:
```json
{
    "/interfaces/loopback/add": { // endpoint к которому будет сгенерирован тест
        "PRESET": { // Блок теста для создания тестовой среды
            "steps": { // Шаги теста
                "1": { // Первый шаг теста
                    "template": "#TEMPLATES./vrf.TESTS.ADD" // Шаблон создания vrf
                },
                "2": {  // Второй шаг теста
                    "endpoint": "/interfaces/loopback/add", // endpoint к которому пойдет запрос
                    "method": "POST", // метод запроса
                    "parameters": { // параметры запроса 
                        "ifname": "random", // имя интерфейса
                        "vrf_name": {"ref": "#PRESET.steps.1.parameters.vrf_name"} // ссылка на параметр vrf_name из шага 1
                    },
                    "expected": {"errCode": 0, "httpCode": 200} // ожидаемый результат запроса
                }
            }
        },
    }
}
```

## Пояснение к тесту с использованием шаблона:
- У нас первый шаг теста `1` - создание vrf. В нем мы узказали, что берем шаблон /vrf: `#TEMPLATES./vrf.TESTS.ADD`, а дальше через точку идут вложенности, которые конкретно нам нужны, то есть `TESTS.ADD`. 
- Второй шаг теста `2` - создание интерфейса loopback. В параметре `vrf_name` указали ссылку `#PRESET.steps.1.parameters.vrf_name` на параметр `vrf_name` из шага `1`, который мы создали в шаблоне. Таким образом мы можем использовать параметры из других шагов теста в текущем шаге теста.